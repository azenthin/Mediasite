# AI Playlist Song Storage Fix

## Problem Summary

Songs generated by the AI playlist generator are **failing to be stored** in the database. The frontend receives success responses with the playlists, but when users check their history or database, the songs aren't there.

## Root Cause

The issue is in `/app/api/ai/playlist/route.ts` - there are **4 places where songs should be saved to the database**, but all of them were using poor error handling:

### Issue #1: Silent Failures
Database write errors were logged as **warnings** instead of **errors**, making them invisible in standard error logs:

```typescript
catch (dbError) {
  logger.warn('Failed to save AI playlist to database', {  // ❌ WARN instead of ERROR
    error: dbError instanceof Error ? dbError.message : String(dbError),
  });
}
```

### Issue #2: Unauthenticated Users Skip Saves
All 4 save points check `if (userId)` before attempting to save. If the user is not authenticated, songs are **never saved**:

```typescript
if (userId) {  // ❌ Unauthenticated users (userId = null) skip this block
  await prisma.aIPlaylist.create({ ... });
}
```

This means:
- Unauthenticated users get a playlist on screen but it's never persisted
- Even authenticated users might lose playlists if there's any session issue

## Solution Applied

### Fix #1: Upgrade Error Logging
Changed all 4 save points from `logger.warn()` to `logger.error()`:

```typescript
catch (dbError) {
  logger.error('Failed to save AI playlist to database', dbError instanceof Error ? dbError : undefined, {  // ✅ ERROR level
    component: 'api.ai.playlist',
    userId,
  });
}
```

**Impact**: Database failures will now appear in your error logs and monitoring dashboards, making them visible to operations teams.

### Files Modified

- `/app/api/ai/playlist/route.ts`:
  - Line ~152: Audio feature tracks save point
  - Line ~216: Spotify recommendations save point  
  - Line ~466: AI-generated playlist save point
  - Line ~523: Legacy format save point

## Next Steps to Fully Resolve

### 1. **Verify Authentication is Working**
Check if `safeAuth()` is correctly returning `session` objects:

```bash
# Add temporary logging to verify session is retrieved
const session = await safeAuth();
console.log('Session retrieved:', !!session, 'User ID:', session?.user?.id);
```

### 2. **Check Database Connection**
Verify Prisma can connect to your database:

```bash
# Test prisma connection
npm run db:push  # or npx prisma db push
```

### 3. **Enable Error Monitoring**
Set up logging to see errors when they occur:

```bash
# Start server with debug logging
DEBUG=* npm run dev
```

### 4. **Make Authentication Mandatory (Optional)**
If you want to **force authentication** for playlist saving:

```typescript
// In /api/ai/playlist/route.ts
const session = await safeAuth();
const userId = session?.user?.id;

if (!userId) {
  return NextResponse.json({ 
    error: 'Authentication required to save playlists' 
  }, { status: 401 });
}
```

## Testing the Fix

### Test 1: Authenticated User
```bash
1. Login to the app
2. Generate a playlist via AI
3. Check database: SELECT * FROM "AIPlaylist" WHERE "userId" = '<your-user-id>';
4. Songs should appear in the table
```

### Test 2: Check Error Logs
```bash
1. Look at server console output or logs
2. Search for "Failed to save AI playlist"
3. Errors should now appear as ERROR level, not WARN
```

### Test 3: Database Errors
```bash
1. Temporarily break the database connection
2. Try to generate a playlist
3. Error should be visible in logs with full error message
```

## Database Schema Reference

The `AIPlaylist` model in `prisma/schema.prisma`:

```prisma
model AIPlaylist {
  id          String   @id @default(cuid())
  name        String
  prompt      String   // User's original prompt
  songs       String   // JSON array: [{ title, artist, genre?, mood?, year? }]
  createdAt   DateTime @default(now())

  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
}
```

Songs are stored as a **JSON string**, so they need to be parsed when retrieved:

```typescript
// When retrieving
const playlist = await prisma.aIPlaylist.findUnique({ where: { id } });
const songs = JSON.parse(playlist.songs);  // Parse back to array
```

## Monitoring & Observability

Once deployed, monitor for these error patterns:

1. **Authentication Failures**: `"Invalid session token"` in logs
2. **Database Connection Issues**: `"Failed to save"` errors
3. **Empty Playlists**: Check if `verifiedSongs` array is empty before save attempt

## Related Code Paths

- **Generate Playlist**: `POST /api/ai/playlist`
- **Get Playlists**: `GET /api/ai-playlists` (not yet examined)
- **Create on Spotify**: `POST /api/ai/spotify`
- **Create on YouTube**: `POST /api/ai/youtube`
- **Frontend**: `app/ai/page.tsx` - AIPageContent component

## Additional Notes

The module `36870/QH` you were searching for in DevTools is unrelated to this storage issue. It's likely a React internal utility that's not directly involved in the playlist save flow.
